\documentclass[tikz,border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows.meta, positioning, fit, backgrounds, shadows, calc}

% Define colors
\definecolor{usercolor}{RGB}{76, 175, 80}      % Green
\definecolor{agentcolor}{RGB}{33, 150, 243}     % Blue
\definecolor{apicolor}{RGB}{255, 152, 0}        % Orange
\definecolor{rediscolor}{RGB}{220, 57, 18}      % Redis Red
\definecolor{celerycolor}{RGB}{156, 39, 176}    % Purple
\definecolor{wrappercolor}{RGB}{63, 81, 181}    % Indigo
\definecolor{appcolor}{RGB}{96, 125, 139}       % Blue Grey
\definecolor{llmcolor}{RGB}{0, 150, 136}        % Teal

% Define styles
\tikzset{
    box/.style={
        rectangle,
        rounded corners,
        minimum width=3cm,
        minimum height=1cm,
        text centered,
        draw=black,
        line width=0.8pt,
        font=\sffamily\small
    },
    user/.style={
        box,
        fill=usercolor!20,
        draw=usercolor!80,
        line width=1.2pt
    },
    agent/.style={
        box,
        fill=agentcolor!20,
        draw=agentcolor!80,
        line width=1.2pt
    },
    llm/.style={
        box,
        fill=llmcolor!20,
        draw=llmcolor!80,
        minimum width=2.5cm,
        minimum height=0.8cm,
        font=\sffamily\scriptsize
    },
    api/.style={
        box,
        fill=apicolor!20,
        draw=apicolor!80
    },
    redis/.style={
        box,
        fill=rediscolor!20,
        draw=rediscolor!80
    },
    celery/.style={
        box,
        fill=celerycolor!20,
        draw=celerycolor!80
    },
    wrapper/.style={
        box,
        fill=wrappercolor!20,
        draw=wrappercolor!80,
        minimum width=2.5cm,
        minimum height=0.9cm
    },
    app/.style={
        box,
        fill=appcolor!20,
        draw=appcolor!80,
        minimum width=2.5cm,
        minimum height=0.7cm,
        font=\sffamily\scriptsize
    },
    arrow/.style={
        -Stealth,
        line width=1.2pt,
        draw=black!70
    },
    dataflow/.style={
        arrow,
        draw=blue!70,
        dashed
    },
    container/.style={
        rectangle,
        rounded corners,
        draw=black!50,
        line width=1pt,
        inner sep=0.3cm,
        dashed
    },
    label/.style={
        font=\sffamily\bfseries\small,
        text=black!80
    },
    annotation/.style={
        font=\sffamily\scriptsize,
        text=black!60,
        align=center
    }
}

\begin{document}

\begin{tikzpicture}[node distance=1.5cm and 0.8cm]

    % Title
    \node[label, font=\sffamily\bfseries\Large] at (0, 11.5) {Scientific AI Backplane Architecture};
    \node[annotation, text width=10cm] at (0, 10.8) {
        Agentic AI System for Asynchronous HPC Job Submission
    };

    % ==================== USER LAYER ====================
    \node[user, minimum width=4cm] (user) at (0, 9.5) {
        \textbf{User / Researcher}
    };
    \node[annotation, below=0.2cm of user] {Natural language requests};

    % ==================== AGENT LAYER ====================
    \node[agent, minimum width=8cm, minimum height=1.8cm] (agent) at (0, 6.5) {};

    % Agent internal components
    \node[font=\sffamily\bfseries] at (0, 7.1) {AI Agent};
    \node[font=\sffamily\scriptsize, text width=7cm, align=center] at (0, 6.5) {
        \texttt{agent.py} | \texttt{agent\_demo.py} | \texttt{agent\_apps.py}\\
        Function Calling • Parameter Optimization • Result Interpretation
    };

    % LLM Models
    \node[llm, left=0.3cm of agent.west, anchor=east, yshift=0.5cm] (gptoss20b) {
        \textbf{gpt-oss:20b}\\
        20.9B params
    };
    \node[llm, below=0.2cm of gptoss20b] (qwen3) {
        \textbf{qwen3:32b}\\
        32.8B params
    };
    \node[llm, right=0.3cm of agent.east, anchor=west, yshift=0.3cm] (gptoss120b) {
        \textbf{gpt-oss:120b}\\
        120B params\\
        \tiny{(Remote containerized)}
    };

    \node[annotation, above=0.1cm of gptoss120b.north] {\tiny OpenAI-compatible};

    % ==================== API LAYER ====================
    \node[api, minimum width=6cm, below=of agent] (fastapi) {
        \textbf{FastAPI REST API}\\
        \texttt{main.py}
    };

    \node[annotation, right=0.2cm of fastapi.east, text width=3.5cm, align=left] {
        \tiny POST /submit\_job\\
        \tiny POST /submit\_app\_job\\
        \tiny GET /job\_status/\{id\}
    };

    % ==================== REDIS LAYER ====================
    \node[redis, minimum width=6cm, below=of fastapi] (redis) {
        \textbf{Redis Message Broker}\\
        Queue + Result Backend
    };

    % ==================== CELERY LAYER ====================
    \node[celery, minimum width=6cm, below=of redis] (celery) {
        \textbf{Celery Async Worker}\\
        \texttt{tasks.py}
    };

    \node[annotation, left=0.2cm of celery.west, anchor=east, text width=2.5cm, align=right] {
        \tiny submit\_slurm\_job()\\
        \tiny run\_simulation()
    };

    % ==================== WRAPPER LAYER ====================
    \begin{scope}[on background layer]
        \node[container, fit={($(celery.south) + (0,-1.5)$) ($(celery.south) + (-4,-3.8)$) ($(celery.south) + (4,-3.8)$)},
              label={[label, anchor=north]north:Application Wrappers}] (wrapper_container) {};
    \end{scope}

    \node[wrapper, below=1.8cm of celery, xshift=-4.8cm] (qe_wrap) {
        QE Wrapper\\
        \tiny 340 lines
    };
    \node[wrapper, right=0.3cm of qe_wrap] (cp2k_wrap) {
        CP2K Wrapper\\
        \tiny 300 lines
    };
    \node[wrapper, right=0.3cm of cp2k_wrap] (gpaw_wrap) {
        GPAW Wrapper\\
        \tiny 280 lines
    };
    \node[wrapper, below=0.5cm of qe_wrap, xshift=1.65cm] (lammps_wrap) {
        LAMMPS Wrapper\\
        \tiny 360 lines
    };
    \node[wrapper, right=0.3cm of lammps_wrap] (gromacs_wrap) {
        GROMACS Wrapper\\
        \tiny 370 lines
    };

    \node[annotation, below=0.05cm of wrapper_container.south] {
        \texttt{wrappers/} - Unified interface: 2,050 lines of code
    };

    % ==================== APPLICATION LAYER ====================
    \begin{scope}[on background layer]
        \node[container, fit={($(wrapper_container.south) + (0,-1.5)$) ($(wrapper_container.south) + (-4,-3.5)$) ($(wrapper_container.south) + (4,-3.5)$)},
              label={[label, anchor=north]north:Computational Chemistry Applications}] (app_container) {};
    \end{scope}

    \node[app, below=1.8cm of qe_wrap] (qe_app) {
        \textbf{Quantum ESPRESSO}\\
        \tiny Plane-wave DFT
    };
    \node[app, below=1.8cm of cp2k_wrap] (cp2k_app) {
        \textbf{CP2K}\\
        \tiny Mixed basis DFT
    };
    \node[app, below=1.8cm of gpaw_wrap] (gpaw_app) {
        \textbf{GPAW}\\
        \tiny Real-space DFT
    };
    \node[app, below=1.8cm of lammps_wrap] (lammps_app) {
        \textbf{LAMMPS}\\
        \tiny Classical MD
    };
    \node[app, below=1.8cm of gromacs_wrap] (gromacs_app) {
        \textbf{GROMACS}\\
        \tiny Biomolecular MD
    };

    \node[annotation, below=0.05cm of app_container.south] {
        \texttt{APPS/} directory - Production installations
    };

    % ==================== DATA FLOW ARROWS ====================

    % User to Agent
    \draw[arrow] (user) -- node[right, annotation, text width=2cm] {Natural language} (agent);

    % Agent to LLMs (bidirectional)
    \draw[arrow, bend left=15] (agent.west) to node[above, annotation, sloped] {} (gptoss20b.east);
    \draw[arrow, bend left=15] (gptoss20b.west) to node[below, annotation, sloped] {} (agent.west);
    \draw[arrow, bend left=15] (agent.west) to node[above, annotation, sloped] {} (qwen3.east);
    \draw[arrow, bend left=15] (qwen3.west) to node[below, annotation, sloped] {} (agent.west);
    \draw[arrow, bend right=15] (agent.east) to node[above, annotation, sloped] {} (gptoss120b.west);
    \draw[arrow, bend right=15] (gptoss120b.south) to node[below, annotation, sloped] {} (agent.east);

    % Agent to API (bidirectional)
    \draw[arrow] (agent) -- node[right, annotation] {POST /submit\_job} (fastapi);
    \draw[arrow] (fastapi.west) -- +(-0.8,0) |- node[left, annotation, pos=0.25] {GET /job\_status} (agent.west);

    % API to Redis
    \draw[arrow] (fastapi) -- node[right, annotation] {Queue job} (redis);

    % Redis to Celery (bidirectional)
    \draw[arrow] (redis) -- node[right, annotation] {Task dispatch} (celery);
    \draw[dataflow] (celery.east) -- +(0.8,0) |- node[right, annotation, pos=0.7] {Results} (redis.east);

    % Celery to Wrappers
    \draw[arrow] (celery) -- (qe_wrap);
    \draw[arrow] (celery) -- (cp2k_wrap);
    \draw[arrow] (celery) -- (gpaw_wrap);
    \draw[arrow] (celery) -- (lammps_wrap);
    \draw[arrow] (celery) -- (gromacs_wrap);

    % Wrappers to Applications
    \draw[arrow] (qe_wrap) -- node[right, annotation, rotate=90] {\tiny Execute} (qe_app);
    \draw[arrow] (cp2k_wrap) -- (cp2k_app);
    \draw[arrow] (gpaw_wrap) -- (gpaw_app);
    \draw[arrow] (lammps_wrap) -- (lammps_app);
    \draw[arrow] (gromacs_wrap) -- (gromacs_app);

    % Return paths (dashed)
    \draw[dataflow] (qe_app) -- node[left, annotation, rotate=90] {\tiny Results} (qe_wrap);
    \draw[dataflow] (cp2k_app) -- (cp2k_wrap);
    \draw[dataflow] (gpaw_app) -- (gpaw_wrap);
    \draw[dataflow] (lammps_app) -- (lammps_wrap);
    \draw[dataflow] (gromacs_app) -- (gromacs_wrap);

    % ==================== ANNOTATIONS ====================

    % Workflow stages
    \node[annotation, text width=2.5cm, align=left, left=0.5cm of user.west, anchor=east] {
        \textbf{Stage 1:}\\
        Request submission
    };

    \node[annotation, text width=2.5cm, align=left, left=0.5cm of agent.west, anchor=east] {
        \textbf{Stage 2:}\\
        LLM reasoning\\
        \& tool selection
    };

    \node[annotation, text width=2.5cm, align=left, left=0.5cm of fastapi.west, anchor=east] {
        \textbf{Stage 3:}\\
        Async dispatch\\
        (prevents timeout)
    };

    \node[annotation, text width=2.5cm, align=left, left=0.5cm of redis.west, anchor=east] {
        \textbf{Stage 4:}\\
        Queue\\
        management
    };

    \node[annotation, text width=2.5cm, align=left, left=0.5cm of celery.west, anchor=east] {
        \textbf{Stage 5:}\\
        Worker\\
        execution
    };

    % Key Features Box
    \node[box, fill=yellow!15, draw=orange!70, minimum width=4.5cm, minimum height=2.8cm,
          right=0.5cm of redis.east, anchor=west, text width=4cm, align=left, font=\sffamily\tiny] (features) {
        \textbf{\small Key Features:}\\[0.1cm]
        ✓ Prevents LLM timeouts\\
        ✓ Async job processing\\
        ✓ 5 chemistry apps integrated\\
        ✓ 100\% success rate\\
        ✓ Function calling support\\
        ✓ Auto parameter tuning\\
        ✓ Scientific interpretation\\
        ✓ RDKit SMILES support\\
        ✓ Production-ready\\[0.1cm]
        \textbf{Models tested:}\\
        • gpt-oss:20b ✓\\
        • qwen3:32b ✓\\
        • gpt-oss:120b ✓
    };

    % Technology Stack Box
    \node[box, fill=blue!10, draw=blue!70, minimum width=4.5cm, minimum height=2.2cm,
          below=0.5cm of features, text width=4cm, align=left, font=\sffamily\tiny] {
        \textbf{\small Technology Stack:}\\[0.1cm]
        • FastAPI (REST API)\\
        • Celery (Async tasks)\\
        • Redis (Message broker)\\
        • Pydantic (Validation)\\
        • OpenAI SDK (LLM)\\
        • RDKit (Chemistry)\\
        • Python 3.x\\[0.1cm]
        \textbf{Code Statistics:}\\
        ~3,500 lines total
    };

    % Time annotations
    \node[annotation, right=0.2cm of redis.east, anchor=west, text width=1.5cm] {
        \tiny < 100ms\\
        \tiny response
    };

    \node[annotation, below=0.1cm of celery.south, yshift=-0.3cm] {
        \tiny Execution: 10s - 30min
    };

\end{tikzpicture}

\end{document}
