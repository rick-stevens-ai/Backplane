# MACE Prompting Guide

## Overview
MACE (Machine learning Accelerated Computational Environment) provides fast ML-based molecular property predictions. This guide shows how to use MACE tools effectively in the agentic workflow.

## Available MACE Tools

### 1. `mace_predict_energy`
**Purpose:** Fast energy prediction (~0.5s per molecule)
**Best for:** Rapid screening, energy comparisons, initial analysis

**Parameters:**
- `smiles` (required): SMILES string of molecule
- `model_type` (optional):
  - `"off"` - For organic molecules (C, H, N, O) **[DEFAULT]**
  - `"mp"` - For materials/inorganic systems
- `model_size` (optional): `"small"`, `"medium"`, `"large"` **[DEFAULT: medium]**

**Example Prompt:**
```
"Use MACE to quickly predict the energy of water (H2O, SMILES: O)"
"Calculate the energy of pyridine (c1ccncc1) using MACE for fast screening"
```

**Returns:**
```python
{
    "energy": -2081.073597,  # in eV
    "unit": "eV",
    "model": "mace-off-medium"
}
```

---

### 2. `mace_optimize_geometry`
**Purpose:** ML-based geometry optimization (~2s)
**Best for:** Preparing starting structures for DFT, quick structure refinement

**Parameters:**
- `smiles` (required): SMILES string
- `model_type` (optional): `"off"` or `"mp"` **[DEFAULT: off]**
- `fmax` (optional): Force convergence criterion in eV/Å **[DEFAULT: 0.05]**
- `steps` (optional): Maximum optimization steps **[DEFAULT: 200]**

**Example Prompt:**
```
"Use MACE to optimize the geometry of ammonia (NH3)"
"Optimize the structure of pyridine using MACE as a starting point for DFT"
```

**Expected Returns:**
```python
{
    "initial_energy": -2081.5,
    "final_energy": -2082.1,
    "converged": True,
    "steps": 45,
    "optimized_structure": "3\nOptimized\nO 0.0 0.0 0.12\n..."
}
```

**⚠️ Important:** The MCP server may not always return all fields. The code now handles missing values gracefully.

---

### 3. `mace_batch_predict`
**Purpose:** Rapid screening of multiple molecules in one call
**Best for:** Catalyst screening, ligand selection, candidate ranking

**Parameters:**
- `smiles_list` (required): Array of SMILES strings
- `model_type` (optional): `"off"` or `"mp"` **[DEFAULT: off]**

**Example Prompt:**
```
"Screen these NH3 activation catalysts using MACE: ['N', 'c1ccncc1', 'C1=CC=CN=C1']"
"Rank these molecules by energy using fast ML prediction"
```

**Returns:**
```python
[
    {"smiles": "N", "energy": -1234.5, "rank": 1},
    {"smiles": "c1ccncc1", "energy": -1235.2, "rank": 2},
    ...
]
```

---

## Model Selection Guide

### Use `model_type="off"` for:
- ✅ Organic molecules (C, H, N, O, F, Cl, S, P)
- ✅ Drug-like molecules
- ✅ Catalysts with organic ligands
- ✅ Biomolecules
- **Examples:** H2O, NH3, pyridine, Fe(PNP) complexes

### Use `model_type="mp"` for:
- ✅ Inorganic materials
- ✅ Metal oxides
- ✅ Pure metals
- ✅ Crystalline solids
- **Examples:** TiO2, Fe metal surfaces, zeolites

---

## Common Prompting Patterns

### Pattern 1: Quick Energy Check
```
"What's the energy of water (O) using MACE?"
"Use MACE for a fast energy estimate of benzene (c1ccccc1)"
```

### Pattern 2: Before DFT Calculation
```
"First use MACE to optimize the geometry of NH3, then run DFT for accurate results"
"Prepare the structure with MACE optimization before submitting to CP2K"
```

### Pattern 3: Rapid Screening
```
"Screen these 10 ligands using MACE and select the 3 most stable ones for DFT"
"Use MACE to quickly rank these catalyst candidates by energy"
```

### Pattern 4: Geometry + Energy Workflow
```
"Optimize the water molecule geometry with MACE, then calculate accurate energy with CP2K"
```

---

## SMILES Format Tips

### Valid SMILES Examples:
- Water: `O`
- Ammonia: `N`
- Methane: `C`
- Ethanol: `CCO`
- Pyridine: `c1ccncc1`
- Benzene: `c1ccccc1`

### For Complex Molecules:
- Use canonical SMILES (generated by RDKit or ChemDraw)
- Aromatic rings use lowercase: `c` not `C`
- Heteroatoms: `N`, `O`, `S`, `P`

---

## Performance Comparison

| Method | Speed | Accuracy | Use Case |
|--------|-------|----------|----------|
| MACE Energy | ~0.5s | Good | Screening, initial estimates |
| MACE Optimization | ~2s | Fair | Starting structures |
| DFT (CP2K/GPAW) | 30-120s | Excellent | Final results, publication |
| DFT Optimization | 5-15 min | Excellent | Accurate geometries |

---

## Error Handling

### Common Issues:

1. **Invalid SMILES**
   - Error: "Failed to convert SMILES to XYZ"
   - Fix: Check SMILES syntax, ensure valid chemistry

2. **Model Type Mismatch**
   - Issue: Using `mp` model for organic molecules
   - Fix: Use `off` model for organic chemistry

3. **Missing Return Values**
   - Issue: MCP server doesn't return all expected fields
   - Status: ✅ Now handled gracefully with None checks

---

## Best Practices

### ✅ DO:
- Use MACE for rapid screening (10-100 molecules)
- Use MACE to prepare structures before DFT
- Specify SMILES explicitly in your prompt
- Use `off` model for organic molecules (default)
- Check convergence status in optimization results

### ❌ DON'T:
- Don't use MACE for publication-quality results (use DFT)
- Don't optimize transition states with MACE (use DFT)
- Don't expect sub-kcal/mol accuracy
- Don't mix `mp` and `off` models inappropriately

---

## Example Workflow

```
USER: "I need to screen 20 potential NH3 activation catalysts"

AGENT: Uses mace_batch_predict for rapid screening → identifies top 5

USER: "Now optimize the top candidates"

AGENT: Uses mace_optimize_geometry on top 5 → gets good starting structures

USER: "Run DFT on the best 2"

AGENT: Submits run_cp2k with optimized MACE structures → publication-quality results
```

---

## Integration with Agent

The agent automatically:
1. Converts SMILES to XYZ format internally
2. Handles None values from incomplete MCP responses
3. Logs all MACE operations with timing
4. Caches results for repeated calls
5. Falls back to DFT if MACE fails

---

## Testing MACE

Run the standalone test:
```bash
python3 mace_client.py
```

Expected output:
```
Test 1: Single energy prediction
  ✓ Energy: -2081.073597 eV

Test 2: SMILES to energy
  ✓ Ammonia energy: -1234.56 eV

Test 3: Rapid screening
  ✓ Screened 3 molecules:
     Rank 1: N               -1234.56 eV
     Rank 2: NN              -1245.23 eV
     Rank 3: c1ccncc1        -3456.78 eV
```

---

## Summary

**When to use MACE:**
- Need results in seconds, not minutes
- Screening many candidates
- Preparing starting geometries
- Checking rough energy estimates

**When to use DFT instead:**
- Need publication-quality accuracy
- Studying reaction mechanisms
- Calculating transition states
- Final validation of results

**Key Point:** MACE is a screening tool. Always validate important results with DFT!
